{% extends 'base.html' %}

{% block lab %}Новогодние подарки{% endblock %}

{% block main %}
<main class="lab9-page">
    <div class="top-bar">
        <span id="user-info">{{ user_login }}</span>

        {% if user_authenticated %}
            <a href="/lab9/logout" class="auth-btn">Выйти</a>
        {% else %}
            <a href="/lab9/login" class="auth-btn">Войти / Регистрация</a>
        {% endif %}

        {% if user_authenticated %}
            <form action="/lab9/api/reset" method="post" style="display:inline;">
                <button type="submit" class="auth-btn">Дед Мороз</button>
            </form>
        {% endif %}
    </div>

    <div id="remaining"></div>
    <div id="gifts-container" class="gifts-container"></div>
    <div id="snow-container"></div>

    <div id="modal" class="modal">
        <div id="modal-text"></div>
        <img id="modal-img" src="" alt="Gift">
        <button id="close-modal-btn">Закрыть</button>
    </div>
</main>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('gifts-container');
        const snowContainer = document.getElementById('snow-container');
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalImg = document.getElementById('modal-img');
        const closeBtn = document.getElementById('close-modal-btn');

        let gifts = [];

        async function fetchGifts() {
            const res = await fetch('/lab9/api/gifts');
            gifts = await res.json();

            gifts.forEach(gift => {
                if (gift.opened && gift.auth_only) {
                    gift.display_image = '/static/lab9/locked.jpg';
                } else if (gift.opened && !gift.auth_only) {
                    gift.display_image = '/static/lab9/box.jpg';
                } else {
                    if (gift.auth_only) {
                        gift.display_image = '/static/lab9/locked.jpg';
                    } else {
                        gift.display_image = '/static/lab9/box.jpg';
                    }
                }
            });

            renderGifts();
            updateRemaining();
            createSnowflakes();
        }


        function renderGifts() {
            container.innerHTML = '';
            gifts.forEach(gift => {
                const box = document.createElement('img');
                box.src = gift.display_image;
                box.className = 'gift-box';
                box.style.left = (gift.left_pos / 1100 * 100)+'%';
                box.style.top = (gift.top_pos / 600 * 100)+'%';
                box.dataset.opened = gift.opened ? '1' : '0';
                box.style.opacity = gift.opened ? 0.5 : 1;

                box.addEventListener('click', async () => {
                    if (box.dataset.opened==='1') return;
                    const res = await fetch(`/lab9/api/gifts/open/${gift.id}`, {method:'POST'});
                    if (!res.ok) { const err = await res.json(); return alert(err.error); }
                    const data = await res.json();

                    modalText.textContent = data.message;
                    modalImg.src = data.gift_image;
                    modal.style.display='block';

                    box.dataset.opened = '1';
                    box.style.opacity = 0.5;
                    gift.opened = true;
                    gift.display_image = box.src;
                    updateRemaining();
                });

                container.appendChild(box);
            });
        }

        function updateRemaining() {
            document.getElementById('remaining').textContent = `Осталось закрытых коробок: ${gifts.filter(g => !g.opened).length}`;
        }

        function createSnowflakes() {
            snowContainer.innerHTML='';
            for(let i=0;i<50;i++){
                const snow = document.createElement('div');
                snow.className='snowflake';
                snow.textContent='❄';
                snow.style.left=Math.random()*100+'%';
                snow.style.fontSize=10+Math.random()*20+'px';
                snow.style.opacity=0.5+Math.random()*0.5;
                snow.style.top='-50px';
                snowContainer.appendChild(snow);
                snow.animate(
                    [{transform:'translateY(0)'},{transform:`translateY(${container.clientHeight}px)`}],
                    {duration:(5+Math.random()*5)*1000, iterations:Infinity}
                );
            }
        }

        closeBtn.addEventListener('click',()=>modal.style.display='none');
        fetchGifts();
    });
</script>
{% endblock %}
